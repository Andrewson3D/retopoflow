import bpy
import math
from .rftool import RFTool
from ..common.maths import Point,Point2D,Vec2D,Vec
from ..common.ui import UI_Image

@RFTool.action_call('move tool')
class RFTool_Tweak(RFTool):
    ''' Called when RetopoFlow is started, but not necessarily when the tool is used '''
    def init(self):
        self.FSM['move'] = self.modal_move
    
    def name(self): return "Tweak"
    def icon(self): return "rf_tweak_icon"
    def description(self): return 'Moves vertices with falloff'
    
    ''' Called the tool is being switched into '''
    def start(self):
        self.rfwidget.set_widget('brush falloff', color=(0.5, 0.5, 1.0))
    
    def get_ui_icon(self):
        icon = [[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,16],[0,0,0,96],[0,0,0,159],[0,0,0,207],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,207],[0,0,0,159],[0,0,0,96],[0,0,0,16],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,64],[0,0,0,159],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,159],[0,0,0,64],[0,0,0,0],[46,27,13,48],[46,27,13,128],[46,27,13,128],[46,27,13,64],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,16],[0,0,0,159],[0,0,0,255],[0,0,0,255],[0,0,0,255],[32,32,32,255],[112,112,112,255],[175,175,175,255],[207,207,207,255],[255,255,255,255],[255,255,255,255],[191,191,191,255],[175,175,175,255],[112,112,112,255],[32,32,32,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[35,20,10,191],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,159],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,48],[0,0,0,223],[0,0,0,255],[0,0,0,255],[64,64,64,255],[191,191,191,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[191,191,191,255],[64,64,64,255],[12,7,3,255],[46,27,13,255],[46,27,13,255],[124,113,104,255],[124,113,104,255],[46,27,13,255],[46,27,13,255],[46,27,13,80],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,48],[0,0,0,239],[0,0,0,255],[16,16,16,255],[175,175,175,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[229,227,225,255],[95,82,73,255],[46,27,13,255],[124,113,104,255],[255,255,255,255],[255,255,255,255],[137,127,119,255],[46,27,13,255],[46,27,13,159],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,48],[0,0,0,239],[0,0,0,255],[48,48,48,255],[239,239,239,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[137,127,119,255],[72,56,43,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[137,127,119,255],[255,255,255,255],[255,255,255,255],[151,141,134,255],[46,27,13,255],[46,27,13,175],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,16],[0,0,0,223],[0,0,0,255],[48,48,48,255],[239,239,239,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[242,241,240,255],[190,184,179,255],[124,113,104,255],[59,41,28,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[85,60,33,255],[124,92,53,255],[46,27,13,255],[46,27,13,255],[151,141,134,255],[164,155,149,255],[59,41,28,255],[46,27,13,255],[46,27,13,96],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,159],[0,0,0,255],[16,16,16,255],[174,168,163,255],[151,141,134,255],[151,141,134,255],[203,198,195,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[229,227,225,255],[177,170,164,255],[111,98,89,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[59,38,20,255],[137,103,60,255],[216,168,100,255],[255,201,120,255],[255,201,120,255],[124,92,53,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[43,25,12,223],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,64],[0,0,0,255],[0,0,0,255],[61,49,40,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[124,113,104,255],[164,155,149,255],[85,70,58,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[111,81,46,255],[190,147,87,255],[255,201,120,255],[255,201,120,255],[255,201,120,255],[255,200,119,255],[254,199,118,255],[254,197,116,255],[136,100,57,255],[46,27,13,255],[65,49,38,255],[17,10,5,255],[0,0,0,255],[0,0,0,64],[0,0,0,0]],[[0,0,0,0],[0,0,0,175],[0,0,0,255],[17,10,5,255],[46,27,13,255],[46,27,13,255],[137,127,119,255],[137,127,119,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[72,49,26,255],[164,125,73,255],[229,179,107,255],[255,201,120,255],[255,200,119,255],[254,199,118,255],[254,197,117,255],[252,194,113,255],[248,185,104,255],[252,192,112,255],[251,190,110,255],[148,108,61,255],[46,27,13,255],[174,170,166,255],[67,67,67,255],[0,0,0,255],[0,0,0,175],[0,0,0,0]],[[0,0,0,32],[0,0,0,255],[0,0,0,255],[64,50,41,255],[46,27,13,255],[137,127,119,255],[255,255,255,255],[255,255,255,255],[137,127,119,255],[46,27,13,255],[46,27,13,255],[71,46,24,255],[124,92,53,255],[203,157,93,255],[255,200,119,255],[254,199,119,255],[254,198,117,255],[253,196,116,255],[253,194,114,255],[248,184,103,255],[243,172,91,255],[239,163,81,255],[243,172,91,255],[250,186,106,255],[249,184,105,255],[97,66,36,255],[46,27,13,255],[191,189,187,255],[169,169,169,255],[0,0,0,255],[0,0,0,255],[0,0,0,32]],[[0,0,0,96],[0,0,0,255],[48,48,48,255],[124,113,104,255],[46,27,13,255],[151,141,134,255],[255,255,255,255],[255,255,255,255],[137,127,119,255],[46,27,13,255],[136,101,57,255],[254,197,116,255],[254,198,118,255],[253,197,116,255],[253,195,115,255],[252,193,113,255],[250,188,108,255],[245,175,94,255],[241,167,85,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[244,173,92,255],[247,179,100,255],[247,177,99,255],[46,27,13,255],[56,38,25,255],[207,207,207,255],[201,201,201,255],[37,37,37,255],[0,0,0,255],[0,0,0,96]],[[0,0,0,175],[0,0,0,255],[128,128,128,255],[177,170,164,255],[46,27,13,255],[46,27,13,255],[137,127,119,255],[137,127,119,255],[46,27,13,255],[46,27,13,255],[188,143,83,255],[252,194,113,255],[252,192,112,255],[250,189,109,255],[246,180,99,255],[241,168,86,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[244,172,93,255],[245,172,94,255],[207,144,78,255],[46,27,13,255],[86,72,61,255],[202,202,202,255],[196,196,196,255],[96,96,96,255],[0,0,0,255],[0,0,0,159]],[[0,0,0,207],[0,0,0,255],[191,191,191,255],[255,255,255,255],[124,113,104,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[123,88,49,255],[251,189,109,255],[248,182,101,255],[243,172,91,255],[240,165,83,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[243,168,90,255],[243,166,88,255],[156,105,55,255],[46,27,13,255],[109,100,93,255],[196,196,196,255],[190,190,190,255],[138,138,138,255],[0,0,0,255],[0,0,0,207]],[[0,0,0,255],[0,0,0,255],[239,239,239,255],[255,255,255,255],[255,255,255,255],[151,141,134,255],[46,27,13,255],[46,27,13,255],[186,136,77,255],[249,184,105,255],[244,173,92,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[240,163,82,255],[241,161,84,255],[240,159,83,255],[119,76,39,255],[46,27,13,255],[128,122,118,255],[182,182,182,255],[184,184,184,255],[166,166,166,255],[0,0,0,255],[0,0,0,255]],[[0,0,0,255],[0,0,0,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[46,27,13,255],[46,27,13,255],[247,179,101,255],[247,178,99,255],[243,170,89,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,160,80,255],[239,155,78,255],[238,153,77,255],[70,43,21,255],[46,27,13,255],[145,143,141,255],[176,176,176,255],[177,177,177,255],[171,171,171,255],[0,0,0,255],[0,0,0,255]],[[0,0,0,255],[0,0,0,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[46,27,13,255],[46,27,13,255],[245,173,95,255],[245,171,93,255],[242,166,86,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[238,154,76,255],[236,148,72,255],[224,139,67,255],[46,27,13,255],[53,35,22,255],[153,153,153,255],[170,170,170,255],[171,171,171,255],[164,164,164,255],[0,0,0,255],[0,0,0,255]],[[0,0,0,255],[0,0,0,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[46,27,13,255],[46,27,13,255],[243,166,89,255],[242,165,87,255],[240,163,84,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[235,145,69,255],[234,142,67,255],[175,105,49,255],[46,27,13,255],[72,58,47,255],[146,146,146,255],[163,163,163,255],[164,164,164,255],[148,148,148,255],[0,0,0,255],[0,0,0,255]],[[0,0,0,191],[0,0,0,255],[207,207,207,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[46,27,13,255],[46,27,13,255],[241,160,83,255],[240,158,81,255],[239,160,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[238,160,79,255],[233,137,62,255],[232,135,61,255],[139,80,36,255],[46,27,13,255],[95,86,79,255],[139,139,139,255],[163,163,163,255],[158,158,158,255],[114,114,114,255],[0,0,0,255],[0,0,0,191]],[[0,0,0,159],[0,0,0,255],[128,128,128,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[46,27,13,255],[46,27,13,255],[238,153,77,255],[238,152,76,255],[238,157,78,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[236,151,72,255],[230,130,56,255],[230,129,55,255],[92,52,23,255],[46,27,13,255],[109,103,99,255],[138,138,138,255],[158,158,158,255],[151,151,151,255],[73,73,73,255],[0,0,0,255],[0,0,0,159]],[[0,0,0,96],[0,0,0,255],[48,48,48,255],[255,255,255,255],[255,255,255,255],[203,198,195,255],[46,27,13,255],[46,27,13,255],[236,147,71,255],[235,145,70,255],[237,153,75,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[239,163,81,255],[233,142,64,255],[228,124,51,255],[227,122,49,255],[46,27,13,255],[46,27,13,255],[121,119,117,255],[146,146,146,255],[151,151,151,255],[144,144,144,255],[26,26,26,255],[0,0,0,255],[0,0,0,96]],[[0,0,0,16],[0,0,0,255],[0,0,0,255],[199,199,199,255],[255,255,255,255],[177,170,164,255],[46,27,13,255],[46,27,13,255],[175,106,50,255],[233,139,64,255],[235,147,69,255],[237,155,75,255],[237,155,75,255],[237,155,75,255],[237,154,74,255],[236,154,74,255],[236,153,73,255],[236,153,73,255],[236,152,73,255],[236,152,72,255],[229,127,52,255],[159,84,33,255],[113,61,25,255],[46,27,13,255],[46,27,13,255],[129,129,129,255],[151,151,151,255],[144,144,144,255],[107,107,107,255],[0,0,0,255],[0,0,0,255],[0,0,0,16]],[[0,0,0,0],[0,0,0,159],[0,0,0,255],[72,72,72,255],[124,113,104,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[115,67,30,255],[230,130,56,255],[230,128,55,255],[229,127,53,255],[228,125,52,255],[228,123,50,255],[227,121,48,255],[226,120,47,255],[226,118,45,255],[225,116,44,255],[225,114,42,255],[102,54,22,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[83,72,63,255],[144,144,144,255],[137,137,137,255],[37,37,37,255],[0,0,0,255],[0,0,0,159],[0,0,0,0]],[[0,0,0,0],[0,0,0,32],[0,0,0,255],[12,7,3,255],[46,27,13,255],[46,27,13,255],[137,127,119,255],[137,127,119,255],[46,27,13,255],[46,27,13,255],[160,87,36,255],[227,122,49,255],[227,120,47,255],[226,118,46,255],[225,117,44,255],[225,115,42,255],[224,113,41,255],[224,112,40,255],[223,111,39,255],[157,79,29,255],[46,27,13,255],[59,41,28,255],[151,141,134,255],[137,127,119,255],[46,27,13,255],[46,27,13,255],[108,102,98,255],[93,93,93,255],[0,0,0,255],[0,0,0,255],[0,0,0,32],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,143],[23,14,7,255],[46,27,13,255],[137,127,119,255],[255,255,255,255],[255,255,255,255],[151,141,134,255],[46,27,13,255],[69,39,17,255],[91,50,21,255],[91,49,21,255],[91,49,20,255],[91,48,20,255],[90,48,19,255],[90,48,19,255],[90,48,19,255],[90,48,19,255],[68,37,16,255],[46,27,13,255],[151,141,134,255],[255,255,255,255],[255,255,255,255],[137,127,119,255],[46,27,13,255],[74,65,58,255],[8,8,8,255],[0,0,0,255],[0,0,0,143],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,16],[28,17,8,207],[46,27,13,255],[137,127,119,255],[255,255,255,255],[255,255,255,255],[151,141,134,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[151,141,134,255],[255,255,255,255],[255,255,255,255],[137,127,119,255],[46,27,13,255],[23,14,7,255],[0,0,0,255],[0,0,0,207],[0,0,0,16],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[46,27,13,64],[46,27,13,255],[46,27,13,255],[137,127,119,255],[137,127,119,255],[46,27,13,255],[46,27,13,255],[132,123,116,255],[171,166,163,255],[159,154,151,255],[146,141,138,255],[139,134,131,255],[133,128,125,255],[128,123,120,255],[122,118,114,255],[117,112,109,255],[94,85,78,255],[46,27,13,255],[46,27,13,255],[137,127,119,255],[124,113,104,255],[46,27,13,255],[46,27,13,255],[12,7,3,255],[0,0,0,239],[0,0,0,48],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[46,27,13,159],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[111,99,90,255],[215,215,215,255],[210,210,210,255],[204,204,204,255],[198,198,198,255],[187,187,187,255],[179,179,179,255],[172,172,172,255],[165,165,165,255],[166,166,166,255],[159,159,159,255],[86,74,65,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[46,27,13,255],[29,17,8,255],[0,0,0,239],[0,0,0,48],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[46,27,13,96],[28,17,8,207],[23,14,7,255],[17,10,5,255],[54,54,54,255],[150,150,150,255],[204,204,204,255],[198,198,198,255],[192,192,192,255],[186,186,186,255],[179,179,179,255],[173,173,173,255],[167,167,167,255],[159,159,159,255],[152,152,152,255],[145,145,145,255],[76,71,67,255],[23,14,7,255],[23,14,7,255],[12,7,3,255],[0,0,0,207],[0,0,0,48],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,16],[0,0,0,143],[0,0,0,255],[0,0,0,255],[0,0,0,255],[25,25,25,255],[78,78,78,255],[122,122,122,255],[135,135,135,255],[148,148,148,255],[142,142,142,255],[120,120,120,255],[100,100,100,255],[59,59,59,255],[12,12,12,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,143],[0,0,0,16],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,32],[0,0,0,159],[0,0,0,239],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,255],[0,0,0,239],[0,0,0,159],[0,0,0,32],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,16],[0,0,0,80],[0,0,0,143],[0,0,0,191],[0,0,0,223],[0,0,0,255],[0,0,0,255],[0,0,0,223],[0,0,0,191],[0,0,0,143],[0,0,0,80],[0,0,0,16],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]]
        self.ui_icon = UI_Image(icon)
        self.ui_icon.set_size(16, 16)
        return self.ui_icon
    
    def modal_main(self):
        if self.rfcontext.actions.pressed('action'):
            self.rfcontext.undo_push('tweak move')
            radius = self.rfwidget.get_scaled_radius()
            nearest = self.rfcontext.nearest_verts_mouse(radius)
            if not nearest:
                self.rfcontext.undo_cancel()
                return
            Point_to_Point2D = self.rfcontext.Point_to_Point2D
            get_strength_dist = self.rfwidget.get_strength_dist
            self.bmverts = [(bmv, Point_to_Point2D(bmv.co), get_strength_dist(d3d)) for bmv,d3d in nearest]
            self.bmfaces = set([f for bmv,_ in nearest for f in bmv.link_faces])
            #self.rfcontext.select([bmv for bmv,_,_ in self.bmverts])
            self.mousedown = self.rfcontext.actions.mousedown
            return 'move'
        
        # if self.rfcontext.eventd.press in {'RIGHTMOUSE'}:
        #     self.rfcontext.undo_push('tweak move single')
        #     bmv,d3d = self.rfcontext.nearest2D_vert_mouse()
        #     self.bmverts = [(bmv, Point(bmv.co), 0.0)]
        #     self.rfcontext.select(bmv)
        #     self.mousedown = self.rfcontext.eventd.mousedown
        #     return 'move'
        
    
    @RFTool.dirty_when_done
    def modal_move(self):
        if self.rfcontext.actions.released('action'):
            return 'main'
        if self.rfcontext.actions.pressed('cancel'):
            self.rfcontext.undo_cancel()
            return 'main'
        
        delta = Vec2D(self.rfcontext.actions.mouse - self.mousedown)
        set2D_vert = self.rfcontext.set2D_vert
        update_face_normal = self.rfcontext.update_face_normal
        
        for bmv,xy,strength in self.bmverts:
            set2D_vert(bmv, xy + delta*strength)
        for bmf in self.bmfaces:
            update_face_normal(bmf)
    
    def draw_postview(self): pass
    def draw_postpixel(self): pass
    
